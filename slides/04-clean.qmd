---
title: "Get and Clean Data"
subtitle: "Tidyverse - Part 3"
author: "Otho Mantegazza"
execute: 
  echo: true
format:
  revealjs:
    theme: [simple, style/theme.scss]
    incremental: true
    footer: '[2022 CBSER Summer School](https://www.summercompschool.mawazoinstitute.org/)'
editor_options: 
  chunk_output_type: console
---

```{r}
#| include: false
library(dplyr)
library(readr)
library(magrittr)
library(tidyr)
library(palmerpenguins)
library(tibble)
library(ggplot2)
library(readr)
library(here)
```

# Tidy Data

## A couple of words on tidy data

More often than not when we speak about **datasets**, we speak about rectangular data, i.e., data in **two-dimensional table**, with rows and columns.


When we work on rectangular data, we try to shape them according to the  **[Tidy Data Principles](https://tidyr.tidyverse.org/articles/tidy-data.html)**:

1. Every column is a variable.
2. Every row is an observation.
3. Every cell is a single value.

. . . 

When we get new data, they generally aren't in a tidy shape...

# Tools: Read Data with Readr

## Readr

:::: {.columns}

::: {.column width="40%"}
![](https://raw.githubusercontent.com/rstudio/hex-stickers/master/SVG/readr.svg)
:::

::: {.column width="60%"}

[Readr](https://readr.tidyverse.org/) is a package that loads (reads) **Rectangular Text** data in R.

It's fast, it guesses column types explicitly and it's pipe friendly

You can use it to read both local data and online data from a URL.

For example we can use it to read data in CSV and TSV formats and many more.

:::

::::

## Read the Palmer Pengunis dataset {.scrollable}

We can use again on the [Palmer Penguins Dataset](https://allisonhorst.github.io/palmerpenguins/)

The [source code of this package](https://github.com/allisonhorst/palmerpenguins/), is on github; we can find the [tidy CSV data](https://raw.githubusercontent.com/allisonhorst/palmerpenguins/main/inst/extdata/penguins.csv) in the [inst/exdata folder](https://github.com/allisonhorst/palmerpenguins/tree/main/inst/extdata).

. . .

```{r}
#| message: true
penguin_csv_url <- 'https://raw.githubusercontent.com/allisonhorst/palmerpenguins/main/inst/extdata/penguins.csv'
 
read_csv(penguin_csv_url)
```

## {.scrollable}

The tibble that we have loaded and generate d from CSV is not identical to the one that comes already loaded with the `palmerpenguins` package:

```{r}
penguins_from_csv <- 
  penguin_csv_url %>% 
  read_csv()

identical(
  penguins_from_csv,
  palmerpenguins::penguins
)
```

Let's compare them side by side

:::: {.columns}

::: {.column width="50%"}

```{r}
palmerpenguins::penguins %>% 
  glimpse(width = 40)
```

:::

::: {.column width="50%"}

```{r}
penguins_from_csv %>% 
  glimpse(width = 40)
```

:::

::::

Can you spot that column types are different?

<br>
<br>

## Parsing {.smallish}

When we read data from text encoded "delimited" files, such as CSV, we use function that [parse](https://en.wikipedia.org/wiki/Parsing) the file.

When we parse something, we formalize its structure applying a set of grammatical rules.

No parsing rule is perfect, thus we must often review the results and "fix" parsing "mistakes".

```{r}
# specify column types manually

penguins_from_csv <-
  penguin_csv_url %>% 
  read_csv(
    col_types = cols(
      species = col_factor(),
      island = col_factor(),
      flipper_length_mm = col_integer(),
      body_mass_g = col_integer(),
      sex = col_factor(),
      year = col_integer()
    )
  )
```

## Exercise {.exercise}

Find the source code of the [readr package](https://readr.tidyverse.org/).

In the `inst/extdata` folder you can find 10 datasets that display different challenges that you might enconter when you have to load data from an external file.

Load in R at least 3 of those datasets using functions from `readr`.

Get help from [readr's documentation](https://readr.tidyverse.org/) and the [data import chapter](https://r4ds.had.co.nz/data-import.html) of r4ds.

Which function did you use? Did you encounter any parsing failure? How did you fix it?


## Read a dataset from PANGAEA 

[PANGAEA](https://www.pangaea.de/), a Data repository for the evironmental sciences.

For our exercise we will use [this dataset](https://doi.pangaea.de/10.1594/PANGAEA.946258) from Wu et al: 

<br>

::: {.big}

"Effect of barite-bound Sr on detrital Sr isotope systematics in marine sediments with pertinent Mediterranean examples".

:::

<br>

[https://doi.pangaea.de/10.1594/PANGAEA.946258](https://doi.pangaea.de/10.1594/PANGAEA.946258)

## {}

```{r}
pangaea_filename <- 'Dataset_S2_HCl-leaching.tab'

pangaea_path <- here('data-int/Wu-etal_2022/datasets', pangaea_filename)
```

Let's try to read the data file `r pangaea_filename`.

It's a `.tab` file. 

```{r}
#| warning: true

pangaea_data <- 
  pangaea_path %>% 
  read_delim()
```

## {}

If we call `problems()` readr tells us what went wrong.

```{r}
pangaea_data
```

## {}

We can use the arguments:

::: {.nonincremental}

- `delim = '\t'` to tell `read_delim()` that we are reading a file delimited by tabulature (\\t).
- `skip = 49` to tell it that the first 49 rows must be skipped.

:::

```{r}
pangaea_data <- 
  pangaea_path %>% 
  read_delim(delim = '\t',
             skip = 49)
```

## {}

Now the data that we've imported into R looks fine.

```{r}
pangaea_data %>% glimpse()
```


## {.scrollable}

Now the data that we've imported into R looks fine.

```{r}
#| output: text
pangaea_data %>% skimr::skim()
```


## Always check for missing values

`skimr::skim()` shows you how many values are missing in your dataset:

::: {.nonincremental}

- How many missing value are there?
- Where do they occur?

:::

## {.scrollable}

A more formal way to check for missing values.

```{r}
pangaea_data %>% 
  summarise(
    across(
      .fns = ~is.na(.) %>% sum()
    )
  ) %>% 
  glimpse()
```

## Quick checklist when you read new data into R

::: {.nonincremental}

- Check for missing values.
- Check the column types, are they what you expect?
- Check the row number and the column names.
- Optional, check the `head()` and the `tail()` of the file.

:::

Now let's tidy the data.

## Exercise {.exercise}

[Tidytuesday](https://github.com/rfordatascience/tidytuesday) is a weekly data project aimed at learning, collaborating and networking the R ecosystem.

Find this week's dataset and read it in R. Run the checklist from the previous slide on the data that you've read.

If you are donw early, proceed reading data from the previous week or find a colleague to help.

Check Tidytuesday submissions on [Twitter with the hashtag #TidyTuesday](https://twitter.com/hashtag/TidyTuesday)

# Tidy Data

## Which Dataset is Tidy?

A common practical way to organize (empirical) data.

::: {.nonincremental}

- Every column is a variable.
- Every row is an observation.
- Every cell is a single value.
- (Every observational unit is in its own table).

:::

Plus: fixed variables should come first, followed by measured variables.

Reference: An Introduction to [Tidy Data](https://tidyr.tidyverse.org/articles/tidy-data.html)

## {}

```{r}
#| echo: false
#| output: verbatim

friends <- tribble(
  ~name, ~surname, ~age,
  'Joey', 'Tribbiani', 27, 
  'Monica', 'Geller', 24,
  'Rachel', 'Green', 23,
  'Phoebe', 'Buffay', 27,
  'Ross', 'Geller', 26,
  'Chandler', 'Bing', 26
)

set.seed(5)

friends_vector <- 
  friends %>% 
  as.vector() %>% 
  unlist() %>% 
  unname() %>%
  tibble(text = .) %>% 
  mutate(
    left = runif(n(), 0, 1000),
    top = runif(n(), 0, 700)
  ) %>% 
  rowwise() %>% 
  mutate(
    html_div = glue::glue(
      '<div style="position:absolute; left:',
      left,
      'px; top:',
      top,
      '200px; font-size:40px;">',
      text ,
      '</div>'
    )
  ) %>% 
  pull(html_div) %>% 
  paste(collapse = '')
# paste0(
#   .,
  #   ' {.fragment .absolute top=',
  #   runif(1, 1, 800) %>% round(),
  #   ' left=400 height=500} \n'
  # ) %>% 
  # paste0(
  #   '<div style="position:absolute; left:',
  #   ,
  #   'px; top:',
  #   ,
  #   '200px; font-weight:bold;">',. ,'</div>'
  # )

```


`r friends_vector`

## {.scrollable}

```{r}
pangaea_data %>% 
  glimpse()
```

```{r}
pangaea_data <- 
  pangaea_data %>% 
  janitor::clean_names()
```

!! Janitor transforms micro into mini (mu to m)

```{r}
pangaea_data %>% 
  glimpse()
```

Independent variables first, measured ones late.

```{r}
pangaea_data %>%
  count(event, latitude, longitude, elevation_m)
```

```{r}
pangaea_data %>%
  count(event, latitude, longitude, elevation_m, samp_type)
```


```{r}
pangaea_data %>%
  count(event, latitude, longitude, elevation_m, samp_type)
```

These variables define samples univocally.

```{r}
pangaea_data %>%
  count(event, latitude, longitude, elevation_m, samp_type, depth_m)
```

```{r}
pangaea_data %>%
  count(event, latitude, longitude, elevation_m, samp_type, depth_m)
```

Is `ca_co3_percent` a measured variable?

Value as columne name.

Let's pivot the measured variables.

```{r}
pangaea_long <- 
  pangaea_data %>% 
  pivot_longer(
    cols = contains(match = c('leachate', 'residue')),
    values_to = 'value',
    names_to = 'variable'
  )
```

Now it's clear that `variable` contains more than one value.

```{r}
pangaea_long %>% 
  separate(variable, into = c('element', 'type'), sep = '_') %>% 
  view()
```

```{r}

```

## Exercise {.exercise}

Tidy last week's schedule.

![](img/week1-schedule.png)
